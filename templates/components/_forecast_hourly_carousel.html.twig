{# components/_forecast_hourly_carousel.html.twig #}
{# Hourly forecast for the whole day (00:00 → 23:00) with a horizontal carousel #}

<section class="card section-gap">
  <h2 class="h2">
    <svg class="icon" aria-hidden="true"><use href="#icon-clock"/></svg>
    <span>Prévision horaire — aujourd’hui</span>
  </h2>

  <div class="toggle-bar" role="group" aria-label="Options d’affichage">
  <label class="switch">
    <input type="checkbox" class="toggle-wind" checked aria-label="Afficher le vent">
    <span class="slider" aria-hidden="true"></span>
    <span class="switch-label">Vent</span>
  </label>

  <label class="switch">
    <input type="checkbox" class="toggle-precip" checked aria-label="Afficher l’état pluie/neige">
    <span class="slider" aria-hidden="true"></span>
    <span class="switch-label">Précip.</span>
  </label>
</div>

  {% if hours_today is not defined or hours_today is empty %}
    <div class="carousel" role="region" aria-label="Prévision horaire aujourd’hui">
      <div class="carousel-track" role="list">
        {# 4 placeholders #}
        {% for i in 1..4 %}
          <article class="skel-hour" role="listitem" aria-hidden="true">
            <div class="top">
              <div class="skel skel-line" style="width:48px;"></div>
              <div class="skel skel-line" style="width:42px;"></div>
            </div>
            <div class="rows skel-gap">
              <div class="skel skel-line" style="width:80%;"></div>
              <div class="skel skel-line" style="width:70%;"></div>
              <div class="skel skel-line" style="width:65%;"></div>
              <div class="skel skel-line sm" style="width:55%;"></div>
            </div>
            <div class="state">
              <div class="skel skel-line sm"></div>
            </div>
          </article>
        {% endfor %}
      </div>
    </div>
  {% else %}
    <div class="carousel"
    role="region"
    aria-label="Prévision horaire aujourd’hui"
    data-show-wind="1"
    data-show-precip="1">
      <button class="carousel-btn prev" type="button" aria-label="Faire défiler vers la gauche">‹</button>

      <div class="carousel-track" role="list">
        {% for h in hours_today %}
          {# Format HH:mm from ISO #}
          {% set t = h.time|default('') %}
          {% set hhmm = t|length >= 16 ? t|slice(11, 5) : t %}

          {# Safe flags (avoid missing key errors) #}
          {% set past = h.is_past|default(false) %}
          {% set now = h.is_now|default(false) %}

          <article
            class="hour-card{{ past ? ' is-past' : '' }}{{ now ? ' is-now' : '' }}"
            role="listitem"
            aria-label="Heure {{ hhmm }}"
            data-hour="{{ hhmm }}"
            {{ now ? 'data-current="1"' : '' }}
          >
            {# Col 1 — time #}
            <div class="hour">{{ hhmm }}</div>

            {# Col 2 — metrics stack #}
            <div>
              <div class="row">
                <strong>Temp.</strong>
                  <span class="js-temp" data-temp-c="{{ h.temperature is not null ? h.temperature : '' }}">
                  {% if h.temperature is not null %}
                    {{ h.temperature|number_format(1, '.', '') }}°C
                  {% else %}
                    —
                  {% endif %}
                </span>
              </div>

              <div class="row wind-row">
                <strong>Vent</strong>
                <div class="wind-values">
                  <span>
                    {{ h.wind is not null ? (h.wind|number_format(0, '.', '') ~ ' km/h') : '—' }}
                  </span>
                  {% if h.winddirection is defined and h.winddirection is not null %}
                    <span class="wind-dir">
                      <svg class="wind-arrow" style="--deg: {{ h.winddirection }}deg" aria-hidden="true" viewBox="0 0 24 24">
                        <!-- Simple upward arrow; rotation applies via CSS variable -->
                        <path d="M12 3 L8 9 H11 V21 H13 V9 H16 Z" fill="currentColor"/>
                      </svg>

                      {{ h.winddirection }}°
                    </span>
                  {% endif %}
                </div>
              </div>

              {# Humidity row #}
              <div class="row">
                <strong>Humidité</strong>
                <span>
                  {% if h.humidity is defined and h.humidity is not null %}
                    {{ h.humidity|number_format(0, '.', '') }}%
                  {% else %}
                    —
                  {% endif %}
                </span>
              </div>

              {# UV row (no ternary to satisfy TwigCS) #}
              <div class="row">
                <strong>UV</strong>
                <span>
                  {% if h.uv_index is defined and h.uv_index is not null %}
                    {{ h.uv_index|number_format(1, '.', '') }}
                  {% else %}
                    —
                  {% endif %}
                </span>
              </div>
            </div>

            {# Col 3 — state (icon + label), right-aligned by CSS #}
            {% set mm = (h.precip is defined and h.precip is not null) ? h.precip : null %}
            {% set title_mm = (mm is not null and mm > 0) ? (mm|number_format(1, '.', '') ~ ' mm') : '' %}
            <div class="state state-precip" title="{{ title_mm }}">
              <svg class="icon" aria-hidden="true"><use href="#icon-{{ h.icon|default('na') }}"/></svg>
              <span class="small muted">{{ h.label|default('—') }}</span>
            </div>
          </article>
        {% endfor %}
      </div>

      <button class="carousel-btn next" type="button" aria-label="Faire défiler vers la droite">›</button>
    </div>
  {% endif %}
</section>
